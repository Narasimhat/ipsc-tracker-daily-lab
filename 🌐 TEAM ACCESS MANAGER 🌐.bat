@echo off
color 0C
title iPSC Tracker - Team Access Manager
cls

echo.
echo    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
echo    â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
echo       â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
echo       â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
echo       â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
echo       â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•    â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•
echo.
echo    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo                              ğŸŒ Team Access Manager ğŸŒ
echo    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

set "SERVER_PATH=U:\AG_Diecke\DATA MANAGMENT\NT_Literature\iPSC_Tracker"
cd /d "%SERVER_PATH%"

echo    ğŸ” Checking for existing iPSC Tracker instances...
echo.

REM Check for running instances
netstat -an | findstr ":8501 " >nul
if not errorlevel 1 (
    echo    âœ… iPSC Tracker is ALREADY RUNNING on port 8501
    echo       ğŸ“± Access URL: http://localhost:8501
    echo       ğŸŒ Network URL: http://%COMPUTERNAME%:8501
    echo.
    echo    ğŸ’¡ No need to start another instance!
    echo       Just open your browser to the URL above.
    echo.
    goto EXISTING_INSTANCE
)

netstat -an | findstr ":8502 " >nul
if not errorlevel 1 (
    echo    âœ… iPSC Tracker is ALREADY RUNNING on port 8502
    echo       ğŸ“± Access URL: http://localhost:8502
    echo       ğŸŒ Network URL: http://%COMPUTERNAME%:8502
    echo.
    echo    ğŸ’¡ No need to start another instance!
    echo       Just open your browser to the URL above.
    echo.
    goto EXISTING_INSTANCE
)

netstat -an | findstr ":8503 " >nul
if not errorlevel 1 (
    echo    âœ… iPSC Tracker is ALREADY RUNNING on port 8503
    echo       ğŸ“± Access URL: http://localhost:8503
    echo       ğŸŒ Network URL: http://%COMPUTERNAME%:8503
    echo.
    echo    ğŸ’¡ No need to start another instance!
    echo       Just open your browser to the URL above.
    echo.
    goto EXISTING_INSTANCE
)

netstat -an | findstr ":8504 " >nul
if not errorlevel 1 (
    echo    âœ… iPSC Tracker is ALREADY RUNNING on port 8504
    echo       ğŸ“± Access URL: http://localhost:8504
    echo       ğŸŒ Network URL: http://%COMPUTERNAME%:8504
    echo.
    echo    ğŸ’¡ No need to start another instance!
    echo       Just open your browser to the URL above.
    echo.
    goto EXISTING_INSTANCE
)

REM No instance found
echo    âŒ No iPSC Tracker instance found running
echo.
echo    ğŸ¯ Options:
echo       [1] Start new server instance (if you are the designated server manager)
echo       [2] Check network computers for running instances
echo       [3] Exit (someone else should start the server)
echo.

set /p CHOICE="    Select option (1-3): "

if "%CHOICE%"=="1" goto START_SERVER
if "%CHOICE%"=="2" goto NETWORK_CHECK
if "%CHOICE%"=="3" goto EXIT
goto ASK_CHOICE

:START_SERVER
echo.
echo    ğŸš€ Starting new iPSC Tracker instance...
echo    âš ï¸  You are now the SERVER MANAGER for this session!
echo    ğŸ’¡ Keep this window open while others use the application.
echo.
echo    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo    ğŸ“‹ Share these URLs with your team:
echo       â€¢ Local:   http://localhost:8501
echo       â€¢ Network: http://%COMPUTERNAME%:8501
echo    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

timeout /t 3 /nobreak >nul
start "" "http://localhost:8501"

python -m streamlit run app.py --server.port 8501 --server.address 0.0.0.0 --server.headless true

echo.
echo    ğŸ›‘ iPSC Tracker server stopped
echo    ğŸ’¡ Team members can no longer access the application
pause
goto EXIT

:EXISTING_INSTANCE
echo    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo    ğŸ¯ What would you like to do?
echo    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo    [1] Open iPSC Tracker in browser (recommended)
echo    [2] Show server details
echo    [3] Exit
echo.

set /p ACTION="    Select option (1-3): "

if "%ACTION%"=="1" goto OPEN_BROWSER
if "%ACTION%"=="2" goto SERVER_DETAILS
if "%ACTION%"=="3" goto EXIT
goto EXISTING_INSTANCE

:OPEN_BROWSER
echo.
echo    ğŸŒ Opening iPSC Tracker in your browser...

REM Try to detect which port is running
netstat -an | findstr ":8501 " >nul
if not errorlevel 1 (
    start "" "http://localhost:8501"
    goto EXIT
)

netstat -an | findstr ":8502 " >nul
if not errorlevel 1 (
    start "" "http://localhost:8502"
    goto EXIT
)

netstat -an | findstr ":8503 " >nul
if not errorlevel 1 (
    start "" "http://localhost:8503"
    goto EXIT
)

netstat -an | findstr ":8504 " >nul
if not errorlevel 1 (
    start "" "http://localhost:8504"
    goto EXIT
)

echo    âŒ Could not detect running port automatically
echo    ğŸ’¡ Try opening http://localhost:8501 manually
pause
goto EXIT

:SERVER_DETAILS
echo.
echo    ğŸ“Š Server Status Details:
echo    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo    Computer Name: %COMPUTERNAME%
echo    Server Path: %SERVER_PATH%
echo    
for /f "tokens=2" %%i in ('netstat -an ^| findstr ":850"') do (
    echo    Active Port: %%i
)
echo.
echo    ğŸŒ Team Access URLs:
echo       â€¢ http://%COMPUTERNAME%:8501
echo       â€¢ http://%COMPUTERNAME%:8502
echo       â€¢ http://%COMPUTERNAME%:8503
echo       â€¢ http://%COMPUTERNAME%:8504
echo.
pause
goto EXISTING_INSTANCE

:NETWORK_CHECK
echo.
echo    ğŸ” Network Instance Detection Guide:
echo    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo    ğŸ’¡ To check if someone else is running the server:
echo.
echo    1. Ask team members if they started the server
echo    2. Try these common URLs in your browser:
echo       â€¢ http://[COLLEAGUE-COMPUTER]:8501
echo       â€¢ http://[SERVER-COMPUTER]:8501
echo.
echo    3. Check your lab's shared documentation for server info
echo.
echo    ğŸ’¡ If no server is running, designate someone to start it!
echo.
pause
goto EXIT

:EXIT
echo.
echo    ğŸ‘‹ Team Access Manager closing
echo.
echo    ğŸ’¡ Remember: Only ONE server instance should run at a time!
echo    ğŸ’¡ Everyone else uses browsers to connect to that instance.
pause